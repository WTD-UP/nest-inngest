{"version":3,"sources":["../src/index.ts","../src/inngest.module.ts","../src/inngest.decorators.ts"],"sourcesContent":["export * from \"./inngest.decorators\";\nexport * from \"./inngest.module\";\nexport * from \"./inngest.types\";\n","import { Inject, MiddlewareConsumer, NestModule } from \"@nestjs/common\";\n\nimport { DiscoveryModule, DiscoveryService } from \"@golevelup/nestjs-discovery\";\nimport { Inngest } from \"inngest\";\nimport { serve } from \"inngest/express\";\n\nexport const INNGEST_KEY = \"INNGEST\" as const;\nexport const INNGEST_OPTIONS = \"INNGEST_OPTIONS\" as const;\nexport const INNGEST_FUNCTION = \"INNGEST_FUNCTION\" as const;\nexport const INNGEST_TRIGGER = \"INNGEST_TRIGGER\" as const;\n\ntype TriggerConfig = NonNullable<Parameters<Inngest.Any[\"createFunction\"]>[1]>;\n\n/**\n * Deduplicates trigger configurations while preserving order\n */\nfunction dedupeTriggers(triggers: TriggerConfig[]): TriggerConfig[] {\n  const seen = new Set<string>();\n\n  return triggers.filter((trigger) => {\n    const key = JSON.stringify(trigger);\n    if (seen.has(key)) {\n      return false;\n    }\n\n    seen.add(key);\n    return true;\n  });\n}\n\nexport interface InngestModuleOptions {\n  /**\n   * Inngest client instance\n   */\n  inngest: Inngest.Any;\n  /**\n   * Path that inngest will be listening\n   * @default \"/api/inngest\"\n   */\n  path?: string;\n}\n\nexport class InngestModule implements NestModule {\n  constructor(\n    @Inject(DiscoveryService) private readonly discover: DiscoveryService,\n    @Inject(INNGEST_KEY) private readonly inngest: Inngest,\n    @Inject(INNGEST_OPTIONS)\n    private readonly options: Omit<InngestModuleOptions, \"inngest\">,\n  ) {}\n\n  static forRoot({ inngest, ...options }: InngestModuleOptions) {\n    return {\n      imports: [DiscoveryModule],\n      module: InngestModule,\n      providers: [\n        {\n          provide: INNGEST_KEY,\n          useValue: inngest,\n        },\n        {\n          provide: INNGEST_OPTIONS,\n          useValue: options,\n        },\n      ],\n      exports: [],\n      global: true,\n    };\n  }\n\n  public async configure(consumer: MiddlewareConsumer) {\n    const [functions, triggers] = await Promise.all([\n      Promise.all([\n        this.discover.controllerMethodsWithMetaAtKey(INNGEST_FUNCTION),\n        this.discover.providerMethodsWithMetaAtKey(INNGEST_FUNCTION),\n      ]),\n      Promise.all([\n        this.discover.controllerMethodsWithMetaAtKey(INNGEST_TRIGGER),\n        this.discover.providerMethodsWithMetaAtKey(INNGEST_TRIGGER),\n      ]),\n    ]);\n\n    const handlers = functions.flat().map((func) => {\n      const triggerMeta = triggers\n        .flat()\n        .filter(\n          (each) =>\n            each.discoveredMethod.handler === func.discoveredMethod.handler,\n        )\n        .flatMap((each) => each.meta as TriggerConfig[])\n        .filter(Boolean);\n\n      const uniqueTriggers = dedupeTriggers(triggerMeta);\n\n      const triggerArg =\n        uniqueTriggers.length === 0\n          ? undefined\n          : uniqueTriggers.length === 1\n            ? uniqueTriggers[0]\n            : uniqueTriggers;\n\n      return this.inngest.createFunction(\n        // @ts-ignore\n        func.meta,\n        triggerArg,\n        func.discoveredMethod.handler.bind(\n          func.discoveredMethod.parentClass.instance,\n        ),\n      );\n    });\n\n    consumer\n      .apply(\n        serve({\n          client: this.inngest,\n          functions: handlers,\n        }),\n      )\n      .forRoutes(this.options.path ?? \"/api/inngest\");\n  }\n}\n","import { GetEvents, Inngest } from \"inngest\";\nimport { Context } from \"inngest/types\";\n\nimport { INNGEST_FUNCTION, INNGEST_TRIGGER } from \"@/inngest.module\";\n\n// Type for trigger configuration\ntype TriggerConfig = NonNullable<Parameters<Inngest.Any[\"createFunction\"]>[1]>;\n\nexport type ExtractInngest<T> = T extends NestInngest<infer I> ? I : never;\n\nexport class NestInngest<TInngest extends Inngest.Any> {\n  constructor(protected readonly inngest: TInngest) {}\n\n  static from<TOpts extends Inngest.Any>(inngest: TOpts) {\n    return new NestInngest<TOpts>(inngest);\n  }\n\n  /**\n   * Inngest function decorator\n   */\n  public Function(args: Parameters<TInngest[\"createFunction\"]>[0]) {\n    return (\n      target: Object,\n      key: string | symbol,\n      descriptor: PropertyDescriptor,\n    ) => {\n      Reflect.defineMetadata(INNGEST_FUNCTION, args, descriptor.value);\n      return descriptor;\n    };\n  }\n\n  /**\n   * Inngest function trigger decorator\n   * Supports single or multiple triggers via variadic arguments or stacked decorators\n   */\n  public Trigger(...configs: Parameters<TInngest[\"createFunction\"]>[1][]) {\n    return (\n      target: Object,\n      key: string | symbol,\n      descriptor: PropertyDescriptor,\n    ) => {\n      const existing =\n        (Reflect.getMetadata(INNGEST_TRIGGER, descriptor.value) as TriggerConfig[] | undefined) ?? [];\n\n      const normalized = configs.flat();\n\n      Reflect.defineMetadata(\n        INNGEST_TRIGGER,\n        [...existing, ...normalized],\n        descriptor.value,\n      );\n\n      return descriptor;\n    };\n  }\n}\n\nexport namespace NestInngest {\n  export type context<\n    TInngest,\n    TEvent extends keyof GetEvents<ExtractInngest<TInngest>> & string,\n  > = Context<ExtractInngest<TInngest>, TEvent>;\n}\n"],"mappings":"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","names":["INNGEST_KEY","INNGEST_OPTIONS","INNGEST_FUNCTION","INNGEST_TRIGGER","dedupeTriggers","triggers","seen","Set","filter","trigger","key","JSON","stringify","has","add","InngestModule","discover","inngest","options","forRoot","imports","DiscoveryModule","module","providers","provide","useValue","exports","global","configure","consumer","functions","Promise","all","controllerMethodsWithMetaAtKey","providerMethodsWithMetaAtKey","handlers","flat","map","func","triggerMeta","each","discoveredMethod","handler","flatMap","meta","Boolean","uniqueTriggers","triggerArg","length","undefined","createFunction","bind","parentClass","instance","apply","serve","client","forRoutes","path","NestInngest","inngest","from","Function","args","target","key","descriptor","Reflect","defineMetadata","INNGEST_FUNCTION","value","Trigger","configs","existing","getMetadata","INNGEST_TRIGGER","normalized","flat"]}